<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>AWS SSM, Ansible et Raspberry Pi via SSH | Greg. I/O</title>
<meta name="keywords" content="fr, AWS, RaspberryPi, SSM, Ansible, SSH">
<meta name="description" content="Dans ce nouvel article de 2024, d√©couvrez comment AWS Systems Manager (SSM) s&rsquo;int√®gre de mani√®re utile avec le Raspberry Pi (test√© avec les mod√®les 3, Zero et 5). Explorez les possibilit√©s de cette combinaison, id√©ale pour les projets d&rsquo;informatique personnelle d√©centralis√©e. Que vous soyez un passionn√© du Cloud, un amateur d&rsquo;IoT ou simplement curieux, cet article vous r√©serve des surprises !
Cet article sera particuli√®rement utile pour ceux qui cherchent √† acc√©der facilement et de mani√®re s√©curis√©e √† leur Raspberry Pi sans avoir √† configurer le port forwarding sur leur box Internet, et ce, pour un co√ªt minime [^pricing]. Nous utiliserons la fonctionnalit√© Session Manager d&rsquo;AWS SSM. üçá">
<meta name="author" content="">
<link rel="canonical" href="https://gautric.github.io/blog/2024/01/15/aws-ssm-ansible-et-raspberry-pi-via-ssh/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.f247c1259a5749d481b4294f298a6c5d2074697de581723890ba552c718649ff.css" integrity="sha256-8kfBJZpXSdSBtClPKYpsXSB0aX3lgXI4kLpVLHGGSf8=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://gautric.github.io/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://gautric.github.io/android-icon-36x36.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gautric.github.io/android-icon-36x36.png">
<link rel="apple-touch-icon" href="https://gautric.github.io/apple-icon-180x180.png">
<link rel="mask-icon" href="https://gautric.github.io/apple-icon-180x180.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://gautric.github.io/blog/2024/01/15/aws-ssm-ansible-et-raspberry-pi-via-ssh/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:url" content="https://gautric.github.io/blog/2024/01/15/aws-ssm-ansible-et-raspberry-pi-via-ssh/">
  <meta property="og:site_name" content="Greg. I/O">
  <meta property="og:title" content="AWS SSM, Ansible et Raspberry Pi via SSH">
  <meta property="og:description" content="Dans ce nouvel article de 2024, d√©couvrez comment AWS Systems Manager (SSM) s‚Äôint√®gre de mani√®re utile avec le Raspberry Pi (test√© avec les mod√®les 3, Zero et 5). Explorez les possibilit√©s de cette combinaison, id√©ale pour les projets d‚Äôinformatique personnelle d√©centralis√©e. Que vous soyez un passionn√© du Cloud, un amateur d‚ÄôIoT ou simplement curieux, cet article vous r√©serve des surprises ! Cet article sera particuli√®rement utile pour ceux qui cherchent √† acc√©der facilement et de mani√®re s√©curis√©e √† leur Raspberry Pi sans avoir √† configurer le port forwarding sur leur box Internet, et ce, pour un co√ªt minime [^pricing]. Nous utiliserons la fonctionnalit√© Session Manager d‚ÄôAWS SSM. üçá">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-15T09:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-15T09:00:00+00:00">
    <meta property="article:tag" content="Fr">
    <meta property="article:tag" content="AWS">
    <meta property="article:tag" content="RaspberryPi">
    <meta property="article:tag" content="SSM">
    <meta property="article:tag" content="Ansible">
    <meta property="article:tag" content="SSH">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AWS SSM, Ansible et Raspberry Pi via SSH">
<meta name="twitter:description" content="Dans ce nouvel article de 2024, d√©couvrez comment AWS Systems Manager (SSM) s&rsquo;int√®gre de mani√®re utile avec le Raspberry Pi (test√© avec les mod√®les 3, Zero et 5). Explorez les possibilit√©s de cette combinaison, id√©ale pour les projets d&rsquo;informatique personnelle d√©centralis√©e. Que vous soyez un passionn√© du Cloud, un amateur d&rsquo;IoT ou simplement curieux, cet article vous r√©serve des surprises !
Cet article sera particuli√®rement utile pour ceux qui cherchent √† acc√©der facilement et de mani√®re s√©curis√©e √† leur Raspberry Pi sans avoir √† configurer le port forwarding sur leur box Internet, et ce, pour un co√ªt minime [^pricing]. Nous utiliserons la fonctionnalit√© Session Manager d&rsquo;AWS SSM. üçá">
      <meta name="twitter:site" content="@gautric_io">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "https://gautric.github.io/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "AWS SSM, Ansible et Raspberry Pi via SSH",
      "item": "https://gautric.github.io/blog/2024/01/15/aws-ssm-ansible-et-raspberry-pi-via-ssh/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "AWS SSM, Ansible et Raspberry Pi via SSH",
  "name": "AWS SSM, Ansible et Raspberry Pi via SSH",
  "description": "Dans ce nouvel article de 2024, d√©couvrez comment AWS Systems Manager (SSM) s\u0026rsquo;int√®gre de mani√®re utile avec le Raspberry Pi (test√© avec les mod√®les 3, Zero et 5). Explorez les possibilit√©s de cette combinaison, id√©ale pour les projets d\u0026rsquo;informatique personnelle d√©centralis√©e. Que vous soyez un passionn√© du Cloud, un amateur d\u0026rsquo;IoT ou simplement curieux, cet article vous r√©serve des surprises ! Cet article sera particuli√®rement utile pour ceux qui cherchent √† acc√©der facilement et de mani√®re s√©curis√©e √† leur Raspberry Pi sans avoir √† configurer le port forwarding sur leur box Internet, et ce, pour un co√ªt minime [^pricing]. Nous utiliserons la fonctionnalit√© Session Manager d\u0026rsquo;AWS SSM. üçá\n",
  "keywords": [
    "fr", "AWS", "RaspberryPi", "SSM", "Ansible", "SSH"
  ],
  "articleBody": "Dans ce nouvel article de 2024, d√©couvrez comment AWS Systems Manager (SSM) s‚Äôint√®gre de mani√®re utile avec le Raspberry Pi (test√© avec les mod√®les 3, Zero et 5). Explorez les possibilit√©s de cette combinaison, id√©ale pour les projets d‚Äôinformatique personnelle d√©centralis√©e. Que vous soyez un passionn√© du Cloud, un amateur d‚ÄôIoT ou simplement curieux, cet article vous r√©serve des surprises ! Cet article sera particuli√®rement utile pour ceux qui cherchent √† acc√©der facilement et de mani√®re s√©curis√©e √† leur Raspberry Pi sans avoir √† configurer le port forwarding sur leur box Internet, et ce, pour un co√ªt minime [^pricing]. Nous utiliserons la fonctionnalit√© Session Manager d‚ÄôAWS SSM. üçá\nInt√©gration de SSM dans sa flotte de RaspberryPi avec Ansible\nAWS Systems Manager (SSM) AWS Systems Manager (SSM) se positionne comme un outil centralis√© de gestion d‚Äôinfrastructure, simplifiant la supervision et l‚Äôautomatisation des op√©rations pour les ressources AWS, notamment les instances EC2. Ses fonctionnalit√©s avanc√©es, telles que l‚Äôautomatisation des t√¢ches, la collecte de donn√©es op√©rationnelles en temps r√©el et la maintenance automatis√©e des correctifs, renforcent l‚Äôefficacit√© op√©rationnelle et la s√©curit√© dans le cloud. De mani√®re significative, SSM va au-del√† du cloud en permettant √©galement la gestion unifi√©e des instances on-premises, offrant ainsi une solution int√©gr√©e pour la gestion hybride des environnements, consolidant ainsi la surveillance, l‚Äôautomatisation et la conformit√© √† travers des infrastructures diversifi√©es.\nRaspberry Pi 5 Le Raspberry Pi 5 vient r√©volutionner la s√©rie embl√©matique en proposant une puissance de calcul am√©lior√©e, une connectivit√© plus rapide avec le Wi-Fi 6, et une efficacit√© √©nerg√©tique optimis√©e. Dot√© de ports USB-C et capable de supporter des r√©solutions d‚Äôaffichage sup√©rieures, ce dernier mod√®le promet une exp√©rience informatique encore plus performante pour les amateurs, les d√©veloppeurs et les passionn√©s d‚ÄôIoT. Une solution compacte, mais puissante, pr√™te √† ouvrir de nouvelles perspectives cr√©atives.\nAnsible Ansible, un puissant outil open source de gestion de configuration, simplifie l‚Äôautomatisation des d√©ploiements, des mises √† jour et de la gestion des infrastructures informatiques. Bas√© sur un mod√®le d√©claratif simple et utilisant le langage YAML, Ansible permet aux administrateurs syst√®me de d√©finir l‚Äô√©tat d√©sir√© de leurs syst√®mes et d‚Äôorchestrer des t√¢ches complexes de mani√®re efficace, offrant ainsi une solution flexible et extensible pour la gestion d‚Äôinfrastructures √† grande √©chelle.\nPr√©sentation du projet Explorons √† pr√©sent les diff√©rentes t√¢ches Ansible qui permettront de d√©ployer l‚Äôagent AWS Systems Manager (SSM) sur l‚Äôensemble de la flotte de Raspberry Pi. Ces t√¢ches seront soigneusement con√ßues pour assurer un d√©ploiement efficace et uniforme de l‚Äôagent SSM, renfor√ßant ainsi la capacit√© de gestion √† distance de ces dispositifs au sein de l‚Äôinfrastructure.\nPr√©requis Avant de proc√©der √† l‚Äôex√©cution du playbook Ansible, assurez-vous de respecter les pr√©requis suivants :\nAWS CLI : V√©rifiez que la AWS Command Line Interface (CLI) est install√©e sur la machine o√π Ansible sera ex√©cut√©. Vous pouvez t√©l√©charger la CLI AWS √† partir du site officiel d‚ÄôAmazon AWS et suivre les instructions d‚Äôinstallation.\nAnsible : Assurez-vous qu‚ÄôAnsible est install√© sur votre syst√®me. Vous pouvez l‚Äôinstaller via les gestionnaires de paquets de votre syst√®me d‚Äôexploitation ou en utilisant un gestionnaire de paquets Python comme pip. Consultez la documentation officielle d‚ÄôAnsible pour obtenir des instructions d‚Äôinstallation d√©taill√©es.\nCompte AWS : Vous devez disposer d‚Äôun compte AWS valide avec les permissions n√©cessaires pour cr√©er des activations AWS SSM. Assurez-vous que les informations d‚Äôidentification AWS (cl√© d‚Äôacc√®s et cl√© secr√®te) sont configur√©es correctement, soit via le fichier de configuration AWS (~/.aws/config et ~/.aws/credentials), soit via des variables d‚Äôenvironnement.\nR√¥le IAM service-role/AmazonEC2RunCommandRoleForManagedInstances : Assurez-vous qu‚Äôun r√¥le IAM nomm√© service-role/AmazonEC2RunCommandRoleForManagedInstances existe dans votre compte AWS. Ce r√¥le est requis pour ex√©cuter des commandes Systems Manager sur des instances EC2. Si le r√¥le n‚Äôexiste pas, cr√©ez-le en utilisant la console IAM AWS et attribuez les autorisations n√©cessaires.\nUn ou plusieurs Raspberry Pi : Assurez-vous que les cl√©s publiques SSH que vous utilisez pour vous connecter aux Raspberry Pi sont pr√©sentes sur chaque appareil.\nT√¢che de cr√©ation des codes d‚Äôactivation SSM - name: \"Create AWS SSM Activation\" ansible.builtin.command: cmd: \"aws ssm create-activation --iam-role {% raw %}{{aws_iam_role}}{% endraw %} --registration-limit {% raw %}{{ ansible_play_hosts | length }}{% endraw %} --region {% raw %}{{aws_region}}{% endraw %} --tags \\\"Key=os,Value=raspbian\\\" \" register: aws_ssm_activation connection: local delegate_to: localhost become: false become_user: \"{% raw %}{{ansible_user_id}}{% endraw %}\" become_method: runas run_once: true Cette task Ansible, intitul√©e ‚ÄúCreate AWS SSM Activation‚Äù, se charge de cr√©er une activation AWS Systems Manager (SSM) en utilisant le module ansible.builtin.command. L‚Äôactivation est r√©alis√©e en invoquant la commande AWS CLI aws ssm create-activation avec les param√®tres sp√©cifi√©s, tels que le r√¥le IAM, la limite d‚Äôinscription bas√©e sur le nombre d‚Äôh√¥tes Ansible, la r√©gion AWS, et des tags pour identifier l‚ÄôOS (dans ce cas, ‚Äúraspbian‚Äù).\nLe r√©sultat de cette op√©ration est stock√© dans la variable aws_ssm_activation. Ce playbook est con√ßu pour √™tre ex√©cut√© localement (connection: local), en utilisant la commande delegate_to: localhost. Il n‚Äôutilise pas l‚Äô√©l√©vation de privil√®ges (become) pour ex√©cuter la commande en tant qu‚Äôutilisateur sp√©cifi√©.\nIl est important de noter que l‚Äôoption run_once: true assure que cette t√¢che est ex√©cut√©e une seule fois, ind√©pendamment du nombre d‚Äôh√¥tes Ansible. En r√©sum√©, ce playbook automatise la cr√©ation d‚Äôune activation SSM avec des param√®tres sp√©cifiques dans un environnement AWS, contribuant ainsi √† la gestion centralis√©e des ressources.\n- name: Convert output to fact set_fact: aws_ssm_activation_var: \"{% raw %}{{ aws_ssm_activation.stdout | from_json }}{% endraw %} \" connection: local delegate_to: localhost become: false become_user: \"{% raw %}{{ansible_user_id}}{% endraw %}\" become_method: runas run_once: true Nous prendrons en charge la conversion de la sortie (output) au format JSON vers un fact Ansible. Cette √©tape est cruciale pour permettre une manipulation et une analyse ult√©rieure efficace des donn√©es g√©n√©r√©es par nos t√¢ches Ansible.\nT√¢che de t√©l√©chargement et d‚Äôinstallation du binaire SSM Les t√¢ches suivantes dans le playbook ont pour objectif de r√©cup√©rer le binaire d‚Äôinstallation du site AWS et de proc√©der √† son installation sur le Raspberry Pi. Ce processus est fondamental pour garantir que l‚Äôagent AWS Systems Manager (SSM) soit correctement d√©ploy√© sur chaque dispositif. La r√©cup√©ration du binaire se fait via des commandes Ansible, assurant ainsi un t√©l√©chargement s√ªr et efficace depuis la source officielle AWS. Une fois le binaire obtenu, la t√¢che suivante s‚Äôemploie √† ex√©cuter le processus d‚Äôinstallation sur chaque Raspberry Pi de la flotte, permettant ainsi d‚Äô√©tablir la connexion entre les dispositifs et AWS Systems Manager pour une gestion centralis√©e et √† distance. Ces √©tapes sont cruciales pour garantir la coh√©rence et l‚Äôefficacit√© de l‚Äôagent SSM sur l‚Äôensemble de la flotte de Raspberry Pi.\n- name: Download Amazon SSM Agent ansible.builtin.get_url: url: \"{% raw %}{{aws_ssm_deb_url}}{% endraw %}\" dest: \"{% raw %}{{aws_ssm_deb_file}}{% endraw %}\" mode: '0444' - name: Install a Amazon SSM Agent .deb package ansible.builtin.apt: deb: \"{% raw %}{{aws_ssm_deb_file}}{% endraw %}\" T√¢che d‚Äôenregistrement du Raspberry Pi dans l‚Äôinventaire AWS SSM - name: \"Register Amazon SSM Agent\" ansible.builtin.shell: \"amazon-ssm-agent -register -y -id {% raw %}{{aws_ssm_activation_var.ActivationId}}{% endraw %} -code {% raw %}{{aws_ssm_activation_var.ActivationCode}}{% endraw %} -region {% raw %}{{aws_region}}{% endraw %}\" register: aws_ssm_registration - name: Retrieve SSM Instance Id from registration output set_fact: aws_ssm_instance_id: \"{% raw %}{{ aws_ssm_registration.stdout | regex_search('(\\\\w+-\\\\w+)$', multiline=True, ignorecase=True) }}{% endraw %}\" Ces deux t√¢ches du playbook sont d√©di√©es √† l‚Äôenregistrement de l‚Äôagent Amazon SSM (Systems Manager) sur le Raspberry Pi et √† la r√©cup√©ration de l‚Äôidentifiant d‚Äôinstance SSM associ√©.\nT√¢che d‚Äôenregistrement de l‚Äôagent Amazon SSM : La premi√®re t√¢che utilise le module ansible.builtin.shell pour ex√©cuter une commande en ligne de commande. Dans ce cas, elle lance la commande ‚Äúamazon-ssm-agent -register‚Äù, suivie de plusieurs options telles que \"-y\" pour confirmer automatiquement l‚Äôenregistrement, \"-id\" pour sp√©cifier l‚Äôidentifiant d‚Äôactivation obtenu pr√©c√©demment, \"-code\" pour fournir le code d‚Äôactivation, et \"-region\" pour pr√©ciser la r√©gion AWS. Le r√©sultat de cette op√©ration est enregistr√© dans la variable aws_ssm_registration.\nT√¢che de r√©cup√©ration de l‚Äôidentifiant d‚Äôinstance SSM : La deuxi√®me t√¢che utilise le module set_fact pour d√©finir une nouvelle variable appel√©e aws_ssm_instance_id. Elle utilise le filtre regex_search pour extraire l‚Äôidentifiant d‚Äôinstance SSM √† partir de la sortie de la t√¢che d‚Äôenregistrement. La regex (\\w+-\\w+)$ vise √† capturer le motif d‚Äôidentifiant d‚Äôinstance SSM dans la sortie, et la variable nouvellement cr√©√©e aws_ssm_instance_id stocke cette information.\nL‚Äôidentifiant d‚Äôinstance SSM obtenu est ensuite utilis√© pour identifier de mani√®re unique cet agent dans l‚Äôenvironnement AWS, facilitant ainsi sa gestion et sa surveillance √† distance.\nPlaybook Ansible Pour tirer parti de cette int√©gration, un r√©f√©rentiel GitHub est mis √† votre disposition √† l‚Äôadresse suivante : ansible-raspberrypi. Ce r√©f√©rentiel a √©t√© cr√©√© dans le but de simplifier le d√©ploiement de l‚Äôagent AWS Systems Manager (SSM) au sein de votre flotte de Raspberry Pi.\ngautric@MacBookProM2 ansible-raspberrypi % ansible-playbook -i hosts pi_aws_ssm.yml Si tout se passe bien, vous devriez obtenir le r√©sultat suivant dans votre console.\nPLAY [ssm_hosts] **************************************************************** TASK [Gathering Facts] ********************************************************** ok: [raspberrypi.local] TASK [aws_ssm : Create AWS SSM Activation] ************************************** ok: [raspberrypi.local -\u003e localhost] TASK [aws_ssm : Convert output to fact] ***************************************** ok: [raspberrypi.local -\u003e localhost] TASK [aws_ssm : Download Amazon SSM Agent] ************************************** ok: [raspberrypi.local] TASK [aws_ssm : Install a Amazon SSM Agent .deb package] ************************ ok: [raspberrypi.local] TASK [aws_ssm : Stop Amazon SSM Agent] ****************************************** ok: [raspberrypi.local] TASK [aws_ssm : Register Amazon SSM Agent] ************************************** ok: [raspberrypi.local] TASK [aws_ssm : Retrieve SSM Instance Id from registration output] ************** ok: [raspberrypi.local] TASK [aws_ssm : Start Amazon SSM Agent] ***************************************** ok: [raspberrypi.local] TASK [aws_ssm : Enable Amazon SSM Agent] **************************************** ok: [raspberrypi.local] TASK [aws_ssm : Print SSM Instance Id] ****************************************** ok: [raspberrypi.local] =\u003e { \"msg\": \"mi-0123456789abcdef\" } TASK [aws_ssm : Print SSH Instance Id command] ********************************** ok: [raspberrypi.local] =\u003e { \"msg\": \"ssh pi@mi-0123456789abcdef\" } PLAY RECAP ********************************************************************** raspberrypi.local : ok=12 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 Photo finish Une fois l‚Äôagent AWS Systems Manager d√©ploy√© sur votre flotte de Raspberry Pi, vous pouvez retrouver votre instance RaspberryPi directement dans votre console AWS. Cette int√©gration transparente offre une visibilit√© centralis√©e sur l‚Äô√©tat op√©rationnel de chaque dispositif, vous permettant de surveiller, de diagnostiquer et de prendre des mesures √† distance.\nConnexion SSH au dessus de AWS SSM Session Manager Afin de pouvoir se connecter √† votre instance Raspberry Pi, il vous faudra activer le mode Advanced d‚ÄôAWS SSM.\nInfo\nAttention avec les co√ªts de AWS SSM en mode Advanced. N‚Äôoubliez pas de revenir au mode Standard et donc free tier. Information sur le pricing du mode Advanced.\nEnsuite, il sera possible de d√©marrer une session distante via la commande SSH l√©g√®rement configur√©e en utilisant une directive ProxyCommand dans votre fichier .ssh/config.\nVoici la commande de la CLI AWS pour activer le mode Advanced de AWS SSM, qui vous permettra d‚Äôouvrir la session √† distance vers votre Raspberry Pi.\naws ssm update-service-setting \\ --setting-id arn:aws:ssm:eu-west-1:687441526170:servicesetting/ssm/managed-instance/activation-tier \\ --setting-value advanced Le fichier .ssh/config afin d‚Äôutiliser la feature Session Manager dans SSH.\nhost i-* mi-* ProxyCommand sh -c \"aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p'\" La commande SSH vers votre instance Raspberry Pi.\n$\u003e ssh pi@mi-0123456789abcdef Et voil√† ‚Ä¶\nURL Repo Github IAM Role pour SSM Allow and controlling permissions for SSH connections through Session Manager Pricing Session Manager Adv ",
  "wordCount" : "1807",
  "inLanguage": "en",
  "datePublished": "2024-01-15T09:00:00Z",
  "dateModified": "2024-01-15T09:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://gautric.github.io/blog/2024/01/15/aws-ssm-ansible-et-raspberry-pi-via-ssh/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Greg. I/O",
    "logo": {
      "@type": "ImageObject",
      "url": "https://gautric.github.io/apple-icon-180x180.png"
    }
  }
}
</script>
</head>

<body class="" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://gautric.github.io/" accesskey="h" title="Greg. I/O (Alt + H)">
                <img src="https://gautric.github.io/apple-icon-180x180.png" alt="" aria-label="logo"
                    height="35">Greg. I/O</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://gautric.github.io/apropos/" title="√Ä Propos">
                    <span>√Ä Propos</span>
                </a>
            </li>
            <li>
                <a href="https://gautric.github.io/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://gautric.github.io/contact/" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://gautric.github.io/">Home</a>&nbsp;¬ª&nbsp;<a href="https://gautric.github.io/blog/">Blog</a></div>
    <h1 class="post-title entry-hint-parent">
      AWS SSM, Ansible et Raspberry Pi via SSH
    </h1>
    <div class="post-meta"><span title='2024-01-15 09:00:00 +0000 UTC'>January 15, 2024</span>

</div>
  </header> 
  <div class="post-content"><p>Dans ce nouvel article de 2024, d√©couvrez comment AWS Systems Manager (SSM) s&rsquo;int√®gre de mani√®re utile avec le Raspberry Pi (test√© avec les mod√®les 3, Zero et 5). Explorez les possibilit√©s de cette combinaison, id√©ale pour les projets d&rsquo;informatique personnelle d√©centralis√©e. Que vous soyez un passionn√© du Cloud, un amateur d&rsquo;IoT ou simplement curieux, cet article vous r√©serve des surprises !
Cet article sera particuli√®rement utile pour ceux qui cherchent √† acc√©der facilement et de mani√®re s√©curis√©e √† leur Raspberry Pi sans avoir √† configurer le port forwarding sur leur box Internet, et ce, pour un co√ªt minime [^pricing]. Nous utiliserons la fonctionnalit√© Session Manager d&rsquo;AWS SSM. üçá</p>
<blockquote>
<p>Int√©gration de SSM dans sa flotte de RaspberryPi avec Ansible</p>
</blockquote>
<h2 id="aws-systems-manager-ssm">AWS Systems Manager (SSM)<a hidden class="anchor" aria-hidden="true" href="#aws-systems-manager-ssm">#</a></h2>
<p><a href="https://aws.amazon.com/fr/systems-manager/">AWS Systems Manager</a> (SSM) se positionne comme un outil centralis√© de gestion d&rsquo;infrastructure, simplifiant la supervision et l&rsquo;automatisation des op√©rations pour les ressources AWS, notamment les instances EC2. Ses fonctionnalit√©s avanc√©es, telles que l&rsquo;automatisation des t√¢ches, la collecte de donn√©es op√©rationnelles en temps r√©el et la maintenance automatis√©e des correctifs, renforcent l&rsquo;efficacit√© op√©rationnelle et la s√©curit√© dans le cloud. De mani√®re significative, SSM va au-del√† du cloud en permettant √©galement la gestion unifi√©e des instances on-premises, offrant ainsi une solution int√©gr√©e pour la gestion hybride des environnements, consolidant ainsi la surveillance, l&rsquo;automatisation et la conformit√© √† travers des infrastructures diversifi√©es.</p>
<h2 id="raspberry-pi-5">Raspberry Pi 5<a hidden class="anchor" aria-hidden="true" href="#raspberry-pi-5">#</a></h2>
<p>Le <a href="https://www.raspberrypi.com/products/raspberry-pi-5/">Raspberry Pi 5</a> vient r√©volutionner la s√©rie embl√©matique en proposant une puissance de calcul am√©lior√©e, une connectivit√© plus rapide avec le Wi-Fi 6, et une efficacit√© √©nerg√©tique optimis√©e. Dot√© de ports USB-C et capable de supporter des r√©solutions d&rsquo;affichage sup√©rieures, ce dernier mod√®le promet une exp√©rience informatique encore plus performante pour les amateurs, les d√©veloppeurs et les passionn√©s d&rsquo;IoT. Une solution compacte, mais puissante, pr√™te √† ouvrir de nouvelles perspectives cr√©atives.</p>
<h2 id="ansible">Ansible<a hidden class="anchor" aria-hidden="true" href="#ansible">#</a></h2>
<p><a href="https://docs.ansible.com/ansible/latest/network/getting_started/first_playbook.html">Ansible</a>, un puissant outil open source de gestion de configuration, simplifie l&rsquo;automatisation des d√©ploiements, des mises √† jour et de la gestion des infrastructures informatiques. Bas√© sur un mod√®le d√©claratif simple et utilisant le langage YAML, Ansible permet aux administrateurs syst√®me de d√©finir l&rsquo;√©tat d√©sir√© de leurs syst√®mes et d&rsquo;orchestrer des t√¢ches complexes de mani√®re efficace, offrant ainsi une solution flexible et extensible pour la gestion d&rsquo;infrastructures √† grande √©chelle.</p>
<h2 id="pr√©sentation-du-projet">Pr√©sentation du projet<a hidden class="anchor" aria-hidden="true" href="#pr√©sentation-du-projet">#</a></h2>
<p>Explorons √† pr√©sent les diff√©rentes t√¢ches Ansible qui permettront de d√©ployer l&rsquo;agent AWS Systems Manager (SSM) sur l&rsquo;ensemble de la flotte de Raspberry Pi. Ces t√¢ches seront soigneusement con√ßues pour assurer un d√©ploiement efficace et uniforme de l&rsquo;agent SSM, renfor√ßant ainsi la capacit√© de gestion √† distance de ces dispositifs au sein de l&rsquo;infrastructure.</p>
<h3 id="pr√©requis">Pr√©requis<a hidden class="anchor" aria-hidden="true" href="#pr√©requis">#</a></h3>
<p>Avant de proc√©der √† l&rsquo;ex√©cution du playbook Ansible, assurez-vous de respecter les pr√©requis suivants :</p>
<ul>
<li>
<p><strong>AWS CLI</strong> : V√©rifiez que la AWS Command Line Interface (CLI) est install√©e sur la machine o√π Ansible sera ex√©cut√©. <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">Vous pouvez t√©l√©charger la CLI AWS √† partir du site officiel d&rsquo;Amazon AWS et suivre les instructions d&rsquo;installation</a>.</p>
</li>
<li>
<p><strong>Ansible</strong> : Assurez-vous qu&rsquo;Ansible est install√© sur votre syst√®me. Vous pouvez l&rsquo;installer via les gestionnaires de paquets de votre syst√®me d&rsquo;exploitation ou en utilisant un gestionnaire de paquets Python comme pip. <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">Consultez la documentation officielle d&rsquo;Ansible pour obtenir des instructions d&rsquo;installation d√©taill√©es</a>.</p>
</li>
<li>
<p><strong>Compte AWS</strong> : Vous devez disposer <a href="https://console.aws.amazon.com/">d&rsquo;un compte AWS valide</a> avec les permissions n√©cessaires pour cr√©er des activations AWS SSM. Assurez-vous que les informations d&rsquo;identification AWS (cl√© d&rsquo;acc√®s et cl√© secr√®te) sont configur√©es correctement, soit via le fichier de configuration AWS (~/.aws/config et ~/.aws/credentials), soit via des variables d&rsquo;environnement.</p>
</li>
<li>
<p><strong>R√¥le IAM service-role/AmazonEC2RunCommandRoleForManagedInstances</strong> : Assurez-vous qu&rsquo;un r√¥le IAM nomm√© <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-service-role.html">service-role/AmazonEC2RunCommandRoleForManagedInstances</a> existe dans votre compte AWS. Ce r√¥le est requis pour ex√©cuter des commandes Systems Manager sur des instances EC2. Si le r√¥le n&rsquo;existe pas, cr√©ez-le en utilisant la console IAM AWS et attribuez les autorisations n√©cessaires.</p>
</li>
<li>
<p><strong>Un ou plusieurs Raspberry Pi</strong> : Assurez-vous que les cl√©s publiques SSH que vous utilisez pour vous connecter aux Raspberry Pi sont pr√©sentes sur chaque appareil.</p>
</li>
</ul>
<h3 id="t√¢che-de-cr√©ation-des-codes-dactivation-ssm">T√¢che de cr√©ation des codes d&rsquo;activation SSM<a hidden class="anchor" aria-hidden="true" href="#t√¢che-de-cr√©ation-des-codes-dactivation-ssm">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Create AWS SSM Activation&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;aws ssm create-activation --iam-role {% raw %}{{aws_iam_role}}{% endraw %} --registration-limit {% raw %}{{ ansible_play_hosts | length }}{% endraw %}   --region {% raw %}{{aws_region}}{% endraw %}  --tags \&#34;Key=os,Value=raspbian\&#34; &#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">aws_ssm_activation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">become_user</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{% raw %}{{ansible_user_id}}{% endraw %}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">become_method</span><span class="p">:</span><span class="w"> </span><span class="l">runas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">run_once</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>Cette task Ansible, intitul√©e <strong>&ldquo;Create AWS SSM Activation&rdquo;</strong>, se charge de cr√©er une activation AWS Systems Manager (SSM) en utilisant le module <em>ansible.builtin.command</em>. L&rsquo;activation est r√©alis√©e en invoquant la commande AWS CLI <em>aws ssm create-activation</em> avec les param√®tres sp√©cifi√©s, tels que le r√¥le IAM, la limite d&rsquo;inscription bas√©e sur le nombre d&rsquo;h√¥tes Ansible, la r√©gion AWS, et des tags pour identifier l&rsquo;OS (dans ce cas, &ldquo;raspbian&rdquo;).</p>
<p>Le r√©sultat de cette op√©ration est stock√© dans la variable aws_ssm_activation. Ce playbook est con√ßu pour √™tre ex√©cut√© localement (connection: local), en utilisant la commande delegate_to: localhost. Il n&rsquo;utilise pas l&rsquo;√©l√©vation de privil√®ges (become) pour ex√©cuter la commande en tant qu&rsquo;utilisateur sp√©cifi√©.</p>
<p>Il est important de noter que l&rsquo;option run_once: true assure que cette t√¢che est ex√©cut√©e une seule fois, ind√©pendamment du nombre d&rsquo;h√¥tes Ansible. En r√©sum√©, ce playbook automatise la cr√©ation d&rsquo;une activation SSM avec des param√®tres sp√©cifiques dans un environnement AWS, contribuant ainsi √† la gestion centralis√©e des ressources.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Convert output to fact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">set_fact</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">aws_ssm_activation_var</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{% raw %}{{ aws_ssm_activation.stdout | from_json }}{% endraw %} &#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">become_user</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{% raw %}{{ansible_user_id}}{% endraw %}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">become_method</span><span class="p">:</span><span class="w"> </span><span class="l">runas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">run_once</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>Nous prendrons en charge la conversion de la sortie (output) au format JSON vers un fact Ansible. Cette √©tape est cruciale pour permettre une manipulation et une analyse ult√©rieure efficace des donn√©es g√©n√©r√©es par nos t√¢ches Ansible.</p>
<h3 id="t√¢che-de-t√©l√©chargement-et-dinstallation-du-binaire-ssm">T√¢che de t√©l√©chargement et d&rsquo;installation du binaire SSM<a hidden class="anchor" aria-hidden="true" href="#t√¢che-de-t√©l√©chargement-et-dinstallation-du-binaire-ssm">#</a></h3>
<p>Les t√¢ches suivantes dans le playbook ont pour objectif de r√©cup√©rer le binaire d&rsquo;installation du site AWS et de proc√©der √† son installation sur le Raspberry Pi. Ce processus est fondamental pour garantir que l&rsquo;agent AWS Systems Manager (SSM) soit correctement d√©ploy√© sur chaque dispositif. La r√©cup√©ration du binaire se fait via des commandes Ansible, assurant ainsi un t√©l√©chargement s√ªr et efficace depuis la source officielle AWS. Une fois le binaire obtenu, la t√¢che suivante s&rsquo;emploie √† ex√©cuter le processus d&rsquo;installation sur chaque Raspberry Pi de la flotte, permettant ainsi d&rsquo;√©tablir la connexion entre les dispositifs et AWS Systems Manager pour une gestion centralis√©e et √† distance. Ces √©tapes sont cruciales pour garantir la coh√©rence et l&rsquo;efficacit√© de l&rsquo;agent SSM sur l&rsquo;ensemble de la flotte de Raspberry Pi.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Download Amazon SSM Agent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.get_url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{% raw %}{{aws_ssm_deb_url}}{% endraw %}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{% raw %}{{aws_ssm_deb_file}}{% endraw %}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;0444&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Install a Amazon SSM Agent .deb package</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.apt</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">deb</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{% raw %}{{aws_ssm_deb_file}}{% endraw %}&#34;</span><span class="w">
</span></span></span></code></pre></div><h3 id="t√¢che-denregistrement-du-raspberry-pi-dans-linventaire-aws-ssm">T√¢che d&rsquo;enregistrement du Raspberry Pi dans l&rsquo;inventaire AWS SSM<a hidden class="anchor" aria-hidden="true" href="#t√¢che-denregistrement-du-raspberry-pi-dans-linventaire-aws-ssm">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Register Amazon SSM Agent&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.shell</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;amazon-ssm-agent -register -y -id {% raw %}{{aws_ssm_activation_var.ActivationId}}{% endraw %} -code {% raw %}{{aws_ssm_activation_var.ActivationCode}}{% endraw %} -region {% raw %}{{aws_region}}{% endraw %}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">aws_ssm_registration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Retrieve SSM Instance Id from registration output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">set_fact</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">aws_ssm_instance_id</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{% raw %}{{ aws_ssm_registration.stdout | regex_search(&#39;(\\w+-\\w+)$&#39;, multiline=True, ignorecase=True) }}{% endraw %}&#34;</span><span class="w">
</span></span></span></code></pre></div><p>Ces deux t√¢ches du playbook sont d√©di√©es √† l&rsquo;enregistrement de l&rsquo;agent Amazon SSM (Systems Manager) sur le Raspberry Pi et √† la r√©cup√©ration de l&rsquo;identifiant d&rsquo;instance SSM associ√©.</p>
<ul>
<li>
<p><em>T√¢che d&rsquo;enregistrement de l&rsquo;agent Amazon SSM</em> :
La premi√®re t√¢che utilise le module ansible.builtin.shell pour ex√©cuter une commande en ligne de commande. Dans ce cas, elle lance la commande <em>&ldquo;amazon-ssm-agent -register&rdquo;</em>, suivie de plusieurs options telles que <em>&quot;-y&quot;</em> pour confirmer automatiquement l&rsquo;enregistrement, <em>&quot;-id&quot;</em> pour sp√©cifier l&rsquo;identifiant d&rsquo;activation obtenu pr√©c√©demment, <em>&quot;-code&quot;</em> pour fournir le code d&rsquo;activation, et <em>&quot;-region&quot;</em> pour pr√©ciser la r√©gion AWS. Le r√©sultat de cette op√©ration est enregistr√© dans la variable aws_ssm_registration.</p>
</li>
<li>
<p><em>T√¢che de r√©cup√©ration de l&rsquo;identifiant d&rsquo;instance SSM</em> :
La deuxi√®me t√¢che utilise le module set_fact pour d√©finir une nouvelle variable appel√©e <em>aws_ssm_instance_id</em>. Elle utilise le filtre regex_search pour extraire l&rsquo;identifiant d&rsquo;instance SSM √† partir de la sortie de la t√¢che d&rsquo;enregistrement. La regex <em>(\w+-\w+)$</em> vise √† capturer le motif d&rsquo;identifiant d&rsquo;instance SSM dans la sortie, et la variable nouvellement cr√©√©e <em>aws_ssm_instance_id</em> stocke cette information.</p>
</li>
</ul>
<p>L&rsquo;identifiant d&rsquo;instance SSM obtenu est ensuite utilis√© pour identifier de mani√®re unique cet agent dans l&rsquo;environnement AWS, facilitant ainsi sa gestion et sa surveillance √† distance.</p>
<h3 id="playbook-ansible">Playbook Ansible<a hidden class="anchor" aria-hidden="true" href="#playbook-ansible">#</a></h3>
<p>Pour tirer parti de cette int√©gration, un r√©f√©rentiel GitHub est mis √† votre disposition √† l&rsquo;adresse suivante : <a href="https://github.com/gautric/ansible-raspberrypi">ansible-raspberrypi</a>. Ce r√©f√©rentiel a √©t√© cr√©√© dans le but de simplifier le d√©ploiement de l&rsquo;agent AWS Systems Manager (SSM) au sein de votre flotte de Raspberry Pi.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gautric@MacBookProM2 ansible-raspberrypi % ansible-playbook -i hosts pi_aws_ssm.yml 
</span></span></code></pre></div><p>Si tout se passe bien, vous devriez obtenir le r√©sultat suivant dans votre console.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">PLAY [ssm_hosts] ****************************************************************
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [Gathering Facts] **********************************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Create AWS SSM Activation] **************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local -&gt; localhost]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Convert output to fact] *****************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local -&gt; localhost]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Download Amazon SSM Agent] **************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Install a Amazon SSM Agent .deb package] ************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Stop Amazon SSM Agent] ******************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Register Amazon SSM Agent] **************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Retrieve SSM Instance Id from registration output] **************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Start Amazon SSM Agent] *****************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Enable Amazon SSM Agent] ****************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Print SSM Instance Id] ******************************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local] =&gt; {
</span></span><span class="line"><span class="cl">    &#34;msg&#34;: &#34;mi-0123456789abcdef&#34;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TASK [aws_ssm : Print SSH Instance Id command] **********************************
</span></span><span class="line"><span class="cl">ok: [raspberrypi.local] =&gt; {
</span></span><span class="line"><span class="cl">    &#34;msg&#34;: &#34;ssh pi@mi-0123456789abcdef&#34;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PLAY RECAP **********************************************************************
</span></span><span class="line"><span class="cl">raspberrypi.local          : ok=12   changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
</span></span></code></pre></div><h4 id="photo-finish">Photo finish<a hidden class="anchor" aria-hidden="true" href="#photo-finish">#</a></h4>
<p>Une fois l&rsquo;agent AWS Systems Manager d√©ploy√© sur votre flotte de Raspberry Pi, vous pouvez retrouver votre instance RaspberryPi directement dans votre console AWS. Cette int√©gration transparente offre une visibilit√© centralis√©e sur l&rsquo;√©tat op√©rationnel de chaque dispositif, vous permettant de surveiller, de diagnostiquer et de prendre des mesures √† distance.</p>
<p><img alt="AWS Console" loading="lazy" src="/img/aws-ssm.png"></p>
<h3 id="connexion-ssh-au-dessus-de-aws-ssm-session-manager">Connexion SSH au dessus de AWS SSM Session Manager<a hidden class="anchor" aria-hidden="true" href="#connexion-ssh-au-dessus-de-aws-ssm-session-manager">#</a></h3>
<p>Afin de pouvoir se connecter √† votre instance Raspberry Pi, il vous faudra activer le mode Advanced d&rsquo;AWS SSM.</p>
<div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice info" >
<p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"></use></svg></span>Info</p><p>Attention avec les co√ªts de AWS SSM en mode Advanced. N&rsquo;oubliez pas de revenir au mode Standard et donc free tier. <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances-advanced.html">Information sur le pricing du mode Advanced</a>.</p></div>

<p>Ensuite, il sera possible de d√©marrer une session distante via la commande SSH l√©g√®rement configur√©e en utilisant une directive <strong>ProxyCommand</strong> dans votre fichier <em>.ssh/config</em>.</p>
<p>Voici la commande de la CLI AWS pour activer le mode Advanced de AWS SSM, qui vous permettra d&rsquo;ouvrir la session √† distance vers votre Raspberry Pi.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws ssm update-service-setting <span class="se">\
</span></span></span><span class="line"><span class="cl">    --setting-id arn:aws:ssm:eu-west-1:687441526170:servicesetting/ssm/managed-instance/activation-tier <span class="se">\
</span></span></span><span class="line"><span class="cl">    --setting-value advanced
</span></span></code></pre></div><p>Le fichier <em>.ssh/config</em> afin d&rsquo;utiliser la feature Session Manager dans SSH.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">host i-* mi-*
</span></span><span class="line"><span class="cl">    ProxyCommand sh -c &#34;aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters &#39;portNumber=%p&#39;&#34;
</span></span></code></pre></div><p>La commande SSH vers votre instance Raspberry Pi.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; ssh pi@mi-0123456789abcdef
</span></span></code></pre></div><p><em>Et voil√† &hellip;</em></p>
<h2 id="url">URL<a hidden class="anchor" aria-hidden="true" href="#url">#</a></h2>
<ul>
<li><a href="https://github.com/gautric/ansible-raspberrypi">Repo Github</a></li>
<li><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-service-role.html">IAM Role pour SSM</a></li>
<li><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html">Allow and controlling permissions for SSH connections through Session Manager</a></li>
<li><a href="https://aws.amazon.com/systems-manager/pricing/#Session_Manager">Pricing Session Manager Adv</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://gautric.github.io/tags/fr/">Fr</a></li>
      <li><a href="https://gautric.github.io/tags/aws/">AWS</a></li>
      <li><a href="https://gautric.github.io/tags/raspberrypi/">RaspberryPi</a></li>
      <li><a href="https://gautric.github.io/tags/ssm/">SSM</a></li>
      <li><a href="https://gautric.github.io/tags/ansible/">Ansible</a></li>
      <li><a href="https://gautric.github.io/tags/ssh/">SSH</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://gautric.github.io/blog/2024/01/28/activer-d%C3%A9sactiver-sa-camera-poe-via-son-routeur-cisco/">
    <span class="title">¬´ Prev</span>
    <br>
    <span>Activer &amp; D√©sactiver sa camera PoE via son routeur Cisco</span>
  </a>
  <a class="next" href="https://gautric.github.io/blog/2022/06/08/quarkus-java-11-17-et-github-action-feat.-matrix/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>Quarkus &amp; Java 11-17 et GitHub Action feat. Matrix</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2016 - 2025 <a href="https://gautric.github.io/">Greg. I/O</a></span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>
